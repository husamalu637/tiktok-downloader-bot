import asyncio
import aiohttp
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command

# Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…ÙØ¹Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
API_TOKEN = "8235603726:AAHA14coek5rb90rLwO80vkDAMKaId2bw0g"

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# Ø±Ø£Ø³ Ø·Ù„Ø¨ Ù„ØªØ¨Ø¯Ùˆ ÙˆÙƒØ£Ù†Ùƒ Ù…ØªØµÙØ­ Ø­Ù‚ÙŠÙ‚ÙŠ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
}

@dp.message(Command("start"))
async def start_handler(message: types.Message):
    await message.reply("ğŸš€ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯! Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ùƒ.")

@dp.message()
async def download_handler(message: types.Message):
    url = message.text
    if "tiktok.com" in url:
        msg = await message.answer("â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...")
        try:
            async with aiohttp.ClientSession(headers=HEADERS) as session:
                # Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ùƒ (API)
                api_link = f"https://www.tikwm.com/api/?url={url}"
                async with session.get(api_link) as r:
                    res = await r.json()
                    
                    if res.get('code') == 0:
                        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                        video_url = "https://www.tikwm.com" + res['data']['play']
                        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªÙ„Ø¬Ø±Ø§Ù… Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø±Ø§Ù… (256MB)
                        await message.answer_video(video_url, caption="âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
                        await msg.delete()
                    else:
                        await msg.edit_text("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ Ø®Ø§ØµØ§Ù‹.")
        except Exception as e:
            # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            print(f"Error: {e}")
            await msg.edit_text("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.")
    else:
        await message.reply("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ ØµØ­ÙŠØ­.")

async def main():
    # Ø­Ø°Ù Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹Ù„Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ø§Ø±Ø¶ Ø§Ù„ØªÙˆÙƒÙ†
    await bot.delete_webhook(drop_pending_updates=True)
    print("--- Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---")
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main())
    
